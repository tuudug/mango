# Mango v0.2.3: Quest Automation & Progress Tracking

**Goal:** Implement the backend logic to automatically track user actions against active quest criteria, update progress, and mark criteria/quests as ready for claiming. Enhance the frontend to display this progress.

**Prerequisites:** v0.2.1 (Foundation), v0.2.2 (LLM Generation) completed.

**1. Database Schema Changes:**

- No changes anticipated. Ensure `quest_criteria` table has `current_progress` (integer) and `is_met` (boolean) columns. Ensure `quests` table has the `claimable` status in its enum and the `claimable_at` timestamp column.

**2. Backend Implementation:**

- **Central Tracking Service (`questService.ts` or similar):**
  - Implement `updateQuestProgress(userId, actionType: QuestCriterionType, data: Record<string, any>)`:
    - **Input:** `userId`, the type of action that occurred (e.g., 'habit_check'), and relevant data about the action.
    - **Logic:**
      1.  Find all 'active' `quest_criteria` for the `userId` where `criterion.type` matches the `actionType` and `is_met` is false.
      2.  For each matching criterion:
          - Retrieve its `config` (e.g., `{ "habit_id": "uuid", "target_count": 1 }`).
          - Evaluate if the incoming `data` contributes to this specific criterion's goal.
            - **Example (`habit_check`):** Does `data.habitId` match `config.habit_id`?
            - **Example (`steps_reach`):** Does `data.steps` meet/exceed `config.target_steps` for the relevant day/period? (Needs date logic).
            - **Example (`todo_complete`):** Increment progress towards `config.target_count`.
          - If the action contributes:
            - Increment `criterion.current_progress`.
            - Check if `criterion.current_progress` >= `config.target_count` (or equivalent logic for steps/finance).
            - If the target is met, update `criterion.is_met` to `true` in the database.
            - If `is_met` was just set to `true`, proceed to check the parent quest's status.
    - **Quest Claimable Check (Triggered if a criterion `is_met` becomes true):**
      1.  Fetch the parent `quest` for the updated criterion.
      2.  Fetch _all_ `quest_criteria` for that parent quest.
      3.  Check if `allCriteria.every(c => c.is_met === true)`.
      4.  If all criteria are met _and_ the quest `status` is currently 'active':
          - Update the quest `status` to `'claimable'` in the database.
          - Set the `claimable_at` timestamp.
          - (Optional: Trigger a notification to the frontend if using WebSockets).
- **API Integration Points (Modify existing handlers):**
  - **`POST /api/habits/entries` (in `addHabitEntry.ts`):**
    - After successfully adding the entry:
    - Call `updateQuestProgress(userId, 'habit_check', { habitId: addedEntry.habit_id, entryDate: addedEntry.entry_date })`.
  - **`DELETE /api/habits/entries/by-date` (in `deleteHabitEntryByDate.ts`):**
    - _Consideration:_ Need to potentially _decrement_ progress if unchecking affects a quest. This adds complexity. For simplicity, v0.2.3 might ignore decrements, meaning quests only progress forward. Decide on this behavior. If implementing decrements, call `updateQuestProgress` here too, potentially with a negative value or a specific 'uncheck' action type.
  - **`GET /api/health` (or dedicated trigger, e.g., after Google Health sync):**
    - After fetching/updating daily steps:
    - Call `updateQuestProgress(userId, 'steps_reach', { date: entry.date, steps: entry.steps })`. The `updateQuestProgress` function needs logic to handle daily vs. weekly step goals based on criterion config.
  - **`GET /api/finance/entries/today` (or trigger):**
    - After calculating today's spending relative to allowance:
    - Call `updateQuestProgress(userId, 'finance_under_allowance', { date: today, spent: totalSpent, allowance: settings.daily_allowance_goal })`. `updateQuestProgress` checks if `spent <= allowance`.
  - **`PUT /api/todos/:id` (when marking complete):**
    - After successfully marking a todo as complete:
    - Call `updateQuestProgress(userId, 'todo_complete', { count: 1 })`.
  - **Pomodoro Completion:**
    - Identify where Pomodoro session completion is tracked (e.g., in `PomodoroContext` on the frontend, or potentially a backend state if persisted).
    - If tracked frontend-only, the frontend needs to call a new simple API endpoint like `POST /api/user/actions/pomodoro-complete`.
    - This new endpoint handler then calls `updateQuestProgress(userId, 'pomodoro_session', { count: 1 })`.

**3. Frontend Implementation:**

- **Context (`QuestsContext.tsx`):**
  - Ensure `fetchQuests` retrieves criteria including `current_progress` and `is_met`.
- **UI (`QuestsPanel.tsx`):**
  - **Criteria Display:**
    - For each criterion listed under an active quest:
      - Visually indicate if `is_met` is true (e.g., checkmark icon, line-through text).
      - If not met and the criterion has a `target_count` > 1 (or similar progress metric like steps/days), display the progress (e.g., `criterion.current_progress / config.target_count`, or a small progress bar).
  - **Data Refresh:**
    - Implement a mechanism to refresh quest data periodically or on specific triggers (e.g., when the QuestsPanel becomes visible) by calling `fetchQuests()`. This is needed to show progress updates made by the backend. Simple polling or refresh-on-focus might be sufficient for v0.2.3.
  - The "Claim Reward" button logic (from v0.2.1) remains the same, appearing when the quest `status` (fetched from the API) is 'claimable'.

**Testing:**

- Perform actions in the app that should trigger quest progress (check habits, complete todos, finish Pomodoro sessions, ensure steps/finance data is updated).
- Verify that the corresponding `updateQuestProgress` calls are made in the backend logs.
- Check the `quest_criteria` table in the database to confirm `current_progress` and `is_met` are updated correctly.
- Verify that the parent quest `status` changes to 'claimable' when all criteria are met.
- Open the QuestsPanel in the frontend and confirm that progress is displayed accurately for criteria.
- Confirm that the "Claim Reward" button appears correctly when a quest becomes claimable.
- Test the full claim flow -> XP awarded -> Level potentially updated.
- Test edge cases (e.g., multiple criteria of the same type on different quests).

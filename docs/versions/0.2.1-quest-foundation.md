# Mango v0.2.1: Quest System Foundation

**Goal:** Establish the basic database structure, UI panels, context, and API endpoints for managing quests manually, without LLM generation or automatic progress tracking yet. Focus on the core lifecycle: Available -> Active -> Claimable -> Completed/Cancelled.

**1. Database Schema (Supabase):**

- **`quests` Table:**
  - `id` (uuid, pk)
  - `user_id` (uuid, fk to users, index)
  - `description` (text) - _Manually entered for now_
  - `xp_reward` (integer) - _Manually entered for now_
  - `status` (enum: 'available', 'active', 'claimable', 'completed', 'cancelled') - Default 'available'.
  - `type` (enum: 'daily', 'weekly') - _Manually assigned for now_
  - `source` (enum: 'manual', 'llm_generated') - Default 'manual' for this version.
  - `generated_at` (timestampz, default: now())
  - `activated_at` (timestampz, nullable)
  - `claimable_at` (timestampz, nullable) - _Set manually via API for testing_
  - `completed_at` (timestampz, nullable)
  - `cancelled_at` (timestampz, nullable)
- **`quest_criteria` Table:**
  - `id` (uuid, pk)
  - `quest_id` (uuid, fk to quests, index)
  - `description` (text) - _Manually entered for now_
  - `type` (enum: 'habit_check', 'steps_reach', 'finance_under_allowance', 'pomodoro_session', 'todo_complete') - _Informational only for now_
  - `config` (jsonb, nullable) - _Informational only for now_
  - `current_progress` (integer, default: 0) - _Not automatically updated yet_
  - `is_met` (boolean, default: false, index) - _Set manually via API for testing_
  - `created_at` (timestampz, default: now())
- **`user_quest_state` Table:**
  - `user_id` (uuid, pk, fk to users)
  - `last_daily_generated_at` (timestampz, nullable) - _Not used yet_
  - `last_weekly_generated_at` (timestampz, nullable) - _Not used yet_
  - `next_weekly_reset_allowed_at` (timestampz) - _Not used yet_

**2. Backend API Routes:**

- **CRUD for Manual Setup (Internal/Admin Tools or direct DB access initially):**
  - Need a way to insert sample quests and criteria for testing.
- **Core User Routes:**
  - `GET /api/quests`:
    - Accept query params: `status`, `type`.
    - Return quests with their associated `quest_criteria`.
  - `POST /api/quests/:questId/activate`:
    - Check active quest limits (2 daily, 4 weekly).
    - Change quest `status` to 'active', set `activated_at`.
  - `POST /api/quests/:questId/cancel`:
    - Change quest `status` to 'cancelled', set `cancelled_at`.
  - `POST /api/quests/:questId/claim`:
    - **Input:** `questId`
    - **Logic:**
      - Verify quest belongs to user and `status` is `'claimable'`.
      - Update quest `status` to `'completed'`, set `completed_at`.
      - Call `POST /api/user/progress/add-xp` (ensure this XP endpoint exists from the base v0.2 plan).
      - Return success/updated quest state.
  - **(Testing Only) `POST /api/quests/:questId/set-claimable`:**
    - Manually sets the quest status to 'claimable' and `claimable_at`.
  - **(Testing Only) `POST /api/criteria/:criterionId/set-met`:**
    - Manually sets `is_met` to true for a criterion.

**3. Frontend Implementation:**

- **New Panel (`src/components/datasources/QuestsPanel.tsx`):**
  - Add button to `LeftSidebar.tsx` and entry to `dataSourceConfig.ts` (e.g., `Target` icon).
  - **Sections:** "Daily Quests", "Weekly Quests".
  - **Sub-Sections:** "Active Slots", "Available Quests".
- **New Context (`src/contexts/QuestsContext.tsx`):**
  - `useQuests` hook.
  - State: `activeDaily`, `activeWeekly`, `availableDaily`, `availableWeekly` quests (fetched from `GET /api/quests`).
  - Functions:
    - `fetchQuests()`: Calls `GET /api/quests`.
    - `activateQuest(questId)`: Calls `POST /api/quests/:questId/activate`, updates local state.
    - `cancelQuest(questId)`: Calls `POST /api/quests/:questId/cancel`, updates local state.
    - `claimQuest(questId)`: Calls `POST /api/quests/:questId/claim`, updates local state, triggers auth context refresh for XP/Level.
- **UI (`QuestsPanel.tsx`):**
  - **Active Slots:** Display quests. Show description, XP. List criteria, show `criterion.description`. If quest `status` is 'claimable', show "Claim Reward" button (calls `claimQuest`). Otherwise, show "Cancel" button (calls `cancelQuest`).
  - **Available Pool:** Display list of available quests. Show description, XP. Add "Activate" button (calls `activateQuest`, disabled if active slots full).
  - No generation/reset buttons yet.
  - No automatic progress display on criteria yet.

**4. XP System Integration:**

- Ensure the basic XP/Level display in `LeftSidebar.tsx` (from base v0.2 plan) is functional and consumes data from `AuthContext`.
- Ensure the backend `POST /api/user/progress/add-xp` endpoint exists and updates user XP/Level.
- The `claimQuest` function should trigger an update/refresh of the user's auth data to reflect the new XP/Level.

**Testing:** Manually insert quests/criteria into the database. Use testing API endpoints or direct DB manipulation to change criteria `is_met` status and quest `status` to 'claimable' to test the activate, cancel, and claim flows.

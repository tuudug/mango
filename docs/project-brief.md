# Mango App: Project Checklist

Here's a checklist based on the project brief ideas:

## Core Concept

- [ ] **"Game Master" Entity:** A virtual entity that motivates and guides the user.
  - [ ] LLM-Powered: Utilizing LLMs for interaction.
  - [x] UI Mockup: Basic panel exists (`GameMasterPanel.tsx`), includes message input.

## Data Sources & Management

These components handle the interaction and persistence of core application data via React Contexts. **Configuration for data source sidebar buttons (icon, label) is now centralized in `src/lib/dataSourceConfig.ts`.** **API calls within data source contexts are now centralized using `src/lib/apiClient.ts`.**

- [x] **Calendar Data Source (`CalendarDataSource.tsx`):** Manages calendar events (add, delete, view) using `CalendarContext`.
  - **[x] Backend:** Fix token decryption errors. (**Resolved: Incorrect ENV VAR**)
  - **[x] Backend:** Implement refresh token logic. (**Verified: Existing logic works after decryption fix**)
- [x] **Health Data Source (`HealthDataSource.tsx`):** Manages daily step counts (add, update, view) using `HealthContext`.
  - **[x] Backend:** Fix token decryption errors. (**Resolved: Incorrect ENV VAR**)
  - **[x] Backend:** Implement refresh token logic. (**Added: Missing handler in API route**)
  - **[x] Backend:** Fix disconnect logic. (**Fixed: Handler now uses provider from request body**)
- [x] **Todos Data Source (`TodosDataSource.tsx`):** Manages todo items (add, delete, toggle completion) using `TodosContext`.
  - **[x] Editing:** Added ability to edit todo item text.
  - **[x] Reordering:** Top-level items use drag-and-drop; nested items use Move Up/Down buttons.
  - **[x] Sub-items:** Added support for nested sub-items (up to 2 levels).
  - **[x] AI Breakdown:** Added "magic" button to generate sub-tasks using Gemini. **Now includes parent context.**
- [x] **Finance Data Source (`FinanceDataSource.tsx`):** Manages manual finance entries and settings using `FinanceContext`. **Context logic moved to `src/contexts/FinanceContext.tsx`. Panel component renamed/moved.**
  - **[x] Database:** Added `manual_finance_settings` and `manual_finance_entries` tables.
  - **[x] Backend:** Added API routes (`/api/finance`) for settings and entries (GET, PUT, POST, DELETE).
  - **[x] Frontend:** Created context, settings panel (in sidebar), expense entry modal. **Modal moved to `src/components/`.**
- [x] **Pomodoro Context (`PomodoroContext.tsx`):** Manages global Pomodoro state (idle, work, break).
- [x] **Ambience Context (`AmbienceContext.tsx`):** Manages background audio playback state and volume using Web Audio API.

## Key Features

### Quests

- [ ] Generated by the "Game Master".
- [ ] Variety of quests (including easy ones).
- [ ] Randomly timed, low-pressure quests.

### Game Master

- [ ] **Personality/Tone Customization (via Paths):**
  - [ ] Unlock Casual tone.
  - [ ] Unlock Formal tone.
  - [ ] Unlock "Gen Z" / Informal tone.
- [ ] **Availability Limits / Upgrades (via Paths / Subscription):**
  - [ ] Base limit for free users.
  - [ ] Unlock increased limit (Path node?).
  - [ ] Unlimited interaction for subscribers.

### Trackables

- [ ] User-defined statistics (weight, steps, etc.).
- [x] Dashboard display for tracked stats (Partially done - widgets exist, data is static for some).
- [x] **Finance Tracking:**
  - [x] Daily Allowance Widget (`DailyAllowanceWidget.tsx`) - Shows remaining daily budget. **Layout improved.**
  - [x] Expenses Report Widget (`ExpensesReportWidget.tsx`) - Shows weekly spending bar chart.

### Progression System

- [ ] Virtual currency rewards.
- [x] Leveling up (XP gain) - _UI placeholder added to sidebar_.
- [x] **Paths System:**
  - [x] Concept: User selects one linear path at a time; XP contributes to path progress. Switching paths resets progress towards the _next_ item on the previous path.
  - [x] UI Mockup: Implemented as a sliding panel (`PathsPage.tsx`) showing defined paths, active path indication (star icon), progress bar for active path, unlock status (lock/check icon), XP costs, and path switching confirmation.
  - [ ] Path Definition: Finalize items, order, XP costs, level requirements per path.
  - [x] Implementation: Logic for path selection, progress tracking, unlocking items (state managed in `LeftSidebar.tsx` now, saved to localStorage - _Path state only_).
  - [ ] XP Gain Mechanism: Define how users earn XP (e.g., completing quests, using widgets).
- [ ] Widgets unlocked/customized through app usage (via Paths / Shop).
- [ ] **Shop:**
  - [ ] Concept: Purchase widget themes/styles.
  - [ ] Currency: Use virtual currency.
  - [ ] Items: Define specific themes/styles.
  - [ ] Implementation: Build the UI and logic.

### Customizable Dashboard

**Configuration for widgets (types, default layouts, metadata like icons/colors/groups) is now centralized in `src/lib/widgetConfig.ts`.**

- [x] Central hub for progress and planning (`Dashboard.tsx`).
- [x] Add/Move/Resize widgets (`react-grid-layout` integration).
- [x] **Widget Adding:** Replaced drag-and-drop from toolbox with "+" button click; widgets auto-place in first available slot.
- [x] **Layout persistence (Database):**
  - [x] Backend API (`/api/dashboards`) created to GET/PUT layouts.
  - [x] Supabase table (`user_dashboard_layouts`) created.
  - [x] Frontend (`useDashboardLayout` hook) fetches/saves layouts via API.
- [x] **Layout Caching (Local Storage):**
  - [x] Layouts ('default', 'mobile') cached to reduce API calls.
  - [x] Last sync time stored to check cache staleness (12hr).
  - [x] Cache used on initial load; stale cache updated on focus.
  - [x] Fetches forced on entering/exiting edit mode or switching edit target.
  - **[x] Background Fetching:** Implemented background fetching with comparison to avoid unnecessary re-renders.
- [x] **Mobile Layout Support:**
  - [x] Separate 'mobile' layout fetched/saved via API & cached.
  - [x] Automatic loading of 'mobile' or 'default' layout based on screen width (initial load). **Logic centralized in `src/components/dashboard/utils.ts`.**
  - [x] Mobile Edit Mode UI implemented (toggle in edit bar, narrow preview, filtered toolbox).
  - [x] Mobile edit preview uses separate grid instance (`DashboardGrid.tsx`).
  - **[x] Mobile Edit Disabled:** Edit mode button in sidebar is now disabled (shows toast) on mobile viewports. **Logic centralized in `src/components/dashboard/utils.ts`.**
- [ ] **Multiple Named Dashboards:** (Future - requires UI for management)
- [x] **Refined Widget List & Categories (Used for Paths):**
  - **Productivity:**
    - [x] To-do List (`TodoListWidget.tsx` -> `TodoList/index.tsx`) - **Enhanced with Edit, Reorder (DnD/Buttons), Sub-items, AI Breakdown (w/ Context), Tooltips**
    - [x] Month Calendar (`MonthCalendarWidget.tsx`)
    - [x] Daily Calendar (`DailyCalendarWidget.tsx`)
    - [x] Goal Tracker (`GoalTrackerWidget.tsx`)
    - [x] Pomodoro (`PomodoroWidget.tsx`) - **Added basic timer, overflow count-up, progress bar, global banner (work phase only), notification sound.**
      - [ ] _Upgrade:_ Weekly View/Stats
      - [ ] _Upgrade:_ Monthly View/Stats
      - [ ] _Upgrade:_ Advanced Reports
  - **Health & Wellness:**
    - [x] Steps Tracker (`StepsTrackerWidget.tsx`)
      - [x] Dynamic mini/full view based on size.
    - [x] Habit Graph (`HabitGraphWidget.tsx`)
    - [ ] Sleep Widget (_Separated from Steps_) (`SleepStepWidget.tsx` needs refactor)
      - [ ] _Upgrade:_ Sleep Analysis
      - [ ] _Upgrade:_ Daily Routine Generator
    - [ ] Air Quality Widget
  - **Finance:** (**New Category**)
    - [x] Daily Allowance (`DailyAllowanceWidget.tsx`) - **Layout improved, currency symbol prioritized.**
    - [x] Expenses Report (`ExpensesReportWidget.tsx`)
  - **Mindfulness/Focus:** (**New Category**)
    - [x] Journaling Widget (`JournalWidget.tsx`)
    - [x] Affirmation Widget (`AffirmationWidget.tsx`) - **Added random affirmations, clickable text, gradient style.**
    - [x] Ambience (`AmbienceWidget.tsx`) - **Added basic rain sound (FLAC via Web Audio API), play/pause, volume, attribution modal, raindrop animation.**
      - [ ] _Unlock:_ White Noise
      - [ ] _Upgrade:_ Rain Sounds (More variety?)
      - [ ] _Upgrade:_ Wind Sounds
      - [ ] _Upgrade:_ LoFi Music
      - [ ] _Upgrade:_ Bird Sounds
      - [ ] _Upgrade:_ Shore Sounds
    - [ ] Recipe Widget
  - **Information/Utility:**
    - [ ] News Widget (RSS/Reddit)
    - [ ] Weather Widget
  - **Gamification:**
    - [ ] Achievement Showcase
    - [ ] Brain Teaser/Puzzle Widget
    - [ ] _(More Mini-Games - TBD)_
  - **Game Master:** (Path for GM features)
    - [ ] Unlock Casual Tone
    - [ ] Unlock Formal Tone
    - [ ] Unlock 'Gen Z' Tone
    - [ ] Increase Message Limit

## Monetization

- [ ] Subscription-based ($7/month).
- [ ] No ads or IAPs.
- [ ] **Subscriber Advantages:**
  - [ ] Unlimited Game Master interaction (Overrides path limit?).
  - [ ] Early access to new features/widgets.
  - [ ] Exclusive customization options (Shop items?).
  - [ ] Increased reward multiplier.
  - [ ] Advanced data insights/analytics.
  - [ ] Priority support.

## User Experience (UX)

- [ ] Minimal user input focus.
- [x] Intuitive interface (Implemented Left sidebar, sliding panels for Toolbox, GM, Profile, Paths, Data Sources, Finance Settings). **Sidebar refactored for dynamic data source buttons.**
- [x] Dashboard customization implemented.
- [x] **Widget Adding:** Replaced drag-and-drop with click-to-add from toolbox.
- [x] **Panel Behavior:**
  - [x] Panels (except Toolbox) slide over the dashboard content.
  - [x] State and rendering for sliding panels moved into `LeftSidebar.tsx`.
  - [x] Panels use `max-width` for responsiveness.
  - [x] Background overlay added when panels are open.
- [x] **Edit Mode Interaction:**
  - [x] Exiting edit mode always returns to the default desktop view.
  - [x] Attempting to open a panel during edit mode shakes the edit indicator and shows a toast.
  - **[x] Invalid Widget Handling:** Error state with delete button shown for unknown widget types in edit mode.
- [ ] Emphasis on Positive Reinforcement (Guiding principle).
- **[x] PWA Update Notifications:** Implemented prompt for app updates & fixed update flow.
- **[x/âœ“] PWA Error Handling:** Implemented global Error Boundary (`ErrorBoundary.tsx`, `ErrorFallback.tsx`) to catch rendering errors and offer PWA update if available. **Fixed prop passing.**
- **[x] Toast Notifications:** Added system for user feedback (`useToast` context). **Signature updated.**
- **[x] Collapse on Drag:** Todo list items collapse during drag to improve DnD experience.
- **[x] Dashboard Loading:** Improved loading state to avoid full-screen flash (further improved by caching & background fetching).
- **[x] Dark Mode:** Forced dark mode via CSS, ignoring device preference.
- **[x] Development Aids:** Added widget coordinate display in dev mode.
- **[x] Pomodoro Banner:** Banner now pushes content down instead of overlaying.
- **[x] API Call Refactoring:** Centralized authenticated API calls into `src/lib/apiClient.ts` (`authenticatedFetch` function).
- **[x] Transient 401 Error Handling:** Implemented automatic retry logic within `authenticatedFetch` to handle transient 401 errors during token refresh, reducing unnecessary error toasts.

## LLM Prompting Considerations

- [ ] Personalized Quest Generation (using user data).
- [ ] Motivational Tone (customizable via Paths, low-pressure).
- [x] Contextual Awareness (access to user data - **Improved for Todo breakdown**).
- [ ] Adaptability (adjust quest difficulty).
- [ ] Randomized Timing.
- [ ] Urgency/Scarcity (carefully implemented).
- [ ] Adherence to Game Master Availability limits (upgradable via Paths/Subscription).
- **[x] Task Breakdown:** Implemented Gemini integration for breaking down todo items, including prompt refinement **and parent context**.

_(Removed Skill Tree Concept Diagram)_
